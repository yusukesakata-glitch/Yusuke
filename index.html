<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>È°ßÂÆ¢„Éû„ÉÉ„ÉóDB Pro - Sanctuary Ed.</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600&family=Shippori+Mincho:wght@400;500&display=swap" rel="stylesheet">

    <style>
        /* --- „Éá„Ç∂„Ç§„É≥ÂÆöÁæ© --- */
        :root {
            --bg: #f9f8f6;          /* ËÉåÊôØÔºöÁîüÊàê„ÇäËâ≤ */
            --card: #ffffff;        /* „Ç´„Éº„ÉâÔºöÁôΩ */
            --text-main: #2c2c2c;   /* ÊñáÂ≠óÔºöÂ¢®Ëâ≤ */
            --text-sub: #555555;    /* „Çµ„ÉñÊñáÂ≠óÔºö„Ç∞„É¨„Éº */
            --gold: #bfa37e;        /* „Ç¢„ÇØ„Çª„É≥„ÉàÔºö„Ç¥„Éº„É´„Éâ */
            --gold-light: #e6dccf;  /* ËñÑ„ÅÑ„Ç¥„Éº„É´„Éâ */
            --dark: #1a1a1a;        /* Á∑†„ÇÅËâ≤ÔºöÈªí„Å´Ëøë„ÅÑ„Ç∞„É¨„Éº */
            --shadow: 0 10px 30px rgba(0,0,0,0.03);
            --radius: 4px; 
            --font-serif: 'Shippori Mincho', serif;
            --font-eng: 'Cinzel', serif;
        }

        body { font-family: var(--font-serif); background-color: var(--bg); color: var(--text-main); margin: 0; padding: 0; height: 100vh; overflow-y: auto; -webkit-tap-highlight-color: transparent; letter-spacing: 0.05em; }
        .app-container { display: flex; flex-direction: column; height: 100%; max-width: 1600px; margin: 0 auto; padding: 20px; box-sizing: border-box; gap: 20px; }
        @media (min-width: 900px) { body { overflow: hidden; } .app-container { flex-direction: row; padding: 30px; } .left-section { flex: 2; display: flex; flex-direction: column; gap: 15px; height: 100%; } .right-section { flex: 1; display: flex; flex-direction: column; height: 100%; min-width: 420px; overflow-y: auto; padding-right: 5px; } .map-wrapper { flex: 1; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); position: relative; border: 1px solid rgba(0,0,0,0.05); } }
        @media (max-width: 899px) { .app-container { display: block; padding: 15px; } .map-wrapper { height: 50vh; min-height: 350px; border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); position: relative; margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.05); } .right-section { padding-bottom: 100px; } }

        .header-area { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; }
        h1 { font-family: var(--font-eng); font-size: 1.5rem; font-weight: 600; margin: 0; letter-spacing: 0.1em; }
        .btn-settings { background: transparent; border: 1px solid var(--gold); padding: 8px 16px; border-radius: var(--radius); font-family: var(--font-serif); font-size: 0.8rem; cursor: pointer; color: var(--text-main); display: flex; align-items: center; gap: 6px; transition: 0.3s; }
        .btn-settings:hover { background: var(--gold); color: #fff; }

        .search-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .place-search-box { flex: 1; display: flex; align-items: center; background: var(--card); border-radius: var(--radius); padding: 4px 10px; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.05); }
        .place-search-input { flex: 1; border: none; padding: 12px; font-size: 0.95rem; background: transparent; outline: none; font-family: var(--font-serif); }
        .place-search-btn { background: none; border: none; font-size: 1rem; padding: 0 10px; color: var(--gold); cursor: pointer; }

        .filter-area { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        select { width: 100%; padding: 12px; border-radius: var(--radius); border: 1px solid #ddd; background: var(--card); color: var(--text-main); font-family: var(--font-serif); font-size: 0.85rem; appearance: none; text-align: center; cursor: pointer; }
        .list-search-box { position: relative; margin-bottom: 20px; }
        .list-search-box input { width: 100%; padding: 14px 14px 14px 45px; border-radius: var(--radius); border: 1px solid #ddd; background: var(--card); font-size: 0.95rem; box-sizing: border-box; box-shadow: var(--shadow); font-family: var(--font-serif); transition: 0.3s; }
        .list-search-icon { position: absolute; left: 15px; top: 14px; color: var(--gold); font-size: 1.1rem; }

        #google-map-view { width: 100%; height: 100%; }
        .btn-current-loc { position: absolute; bottom: 100px; right: 15px; z-index: 10; width: 40px; height: 40px; background: var(--card); border-radius: 50%; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: none; font-size: 1.2rem; color: var(--text-main); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .map-sync-wrapper { position: absolute; top: 15px; right: 15px; z-index: 10; background: rgba(255, 255, 255, 0.95); padding: 8px 16px; border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px; font-family: var(--font-serif); font-size: 0.8rem; }
        .toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ddd; transition: .4s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--gold); }
        input:checked + .slider:before { transform: translateX(18px); }

        #stats-area { background: var(--card); padding: 20px; border-radius: var(--radius); margin-bottom: 20px; box-shadow: var(--shadow); }
        .stats-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px;}
        .stats-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .stats-item { font-size: 0.75rem; padding: 6px 14px; background: #f4f4f4; border-radius: 2px; cursor: pointer; transition: all 0.3s; }
        .stats-item.selected { background: var(--gold); color: #fff; }

        .customer-item { background: var(--card); padding: 25px; border-radius: var(--radius); margin-bottom: 15px; display: flex; justify-content: space-between; align-items: flex-start; box-shadow: var(--shadow); border: 1px solid rgba(0,0,0,0.02); transition: transform 0.2s; }
        .info-main { font-family: var(--font-serif); font-weight: 600; font-size: 1.1rem; margin-bottom: 8px; line-height: 1.4; }
        .info-sub { font-size: 0.85rem; color: var(--text-sub); margin-bottom: 5px; display: flex; align-items: center; gap: 10px; }
        .tag { background: var(--gold-light); padding: 3px 8px; border-radius: 2px; font-size: 0.7rem; color: #5a4b35; }
        
        .action-area { display: flex; flex-direction: column; gap: 10px; margin-left: 15px; }
        .icon-btn { width: 44px; height: 44px; border-radius: 50%; background: #fcfcfc; border: 1px solid #eee; display: flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1.1rem; transition: all 0.3s; color: var(--text-main); }
        .icon-btn:hover { background: var(--gold); color: #fff; }

        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(44, 44, 44, 0.7); backdrop-filter: blur(5px); display:none; justify-content:center; align-items:center; z-index:9999; }
        .modal-content { background: #fff; padding: 30px; border-radius: 2px; width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
        .settings-section { border-bottom: 1px solid #f0f0f0; padding-bottom: 25px; margin-bottom: 25px; }
        label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--gold); margin-bottom: 8px; margin-top: 15px; font-family: var(--font-eng); }
        input[type="text"], input[type="password"], textarea { width: 100%; padding: 12px; border: 1px solid #ddd; background: #fff; border-radius: var(--radius); box-sizing: border-box; font-size: 16px; font-family: var(--font-serif); }
        .btn-main { width: 100%; padding: 16px; background: var(--dark); color: #fff; border: none; border-radius: var(--radius); font-weight: 500; cursor: pointer; margin-top: 20px; font-family: var(--font-eng); }
        .btn-sub { padding: 10px; background: #fff; border: 1px solid #ddd; border-radius: var(--radius); font-weight: 500; cursor: pointer; font-size: 0.8rem; }
        .btn-del { width: 100%; margin-top: 30px; padding: 12px; background: transparent; color: #999; border: 1px solid #eee; border-radius: var(--radius); cursor: pointer; font-size: 0.8rem; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="left-section">
        <div class="search-row">
            <div class="place-search-box">
                <input type="text" id="mapJumpInput" class="place-search-input" placeholder="Area Search (e.g. Ginza)" onkeydown="if(event.key==='Enter')searchMapLocation()">
                <button class="place-search-btn" onclick="searchMapLocation()">üîç</button>
            </div>
        </div>
        <div class="map-wrapper">
            <div id="google-map-view"></div>
            <div id="map-placeholder-msg" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);">Initializing Map...</div>
            <div class="map-sync-wrapper">
                <span>SYNC MAP</span>
                <label class="toggle-switch"><input type="checkbox" id="mapSyncToggle" onchange="toggleMapSync()"><span class="slider"></span></label>
            </div>
            <button class="btn-current-loc" id="gpsBtn" onclick="toggleGPS()">‚óé</button>
        </div>
    </div>

    <div class="right-section">
        <div class="header-area">
            <h1>È°ßÂÆ¢„Éû„ÉÉ„ÉóDB Pro</h1>
            <button class="btn-settings" onclick="openSettings()">‚öôÔ∏è SETTINGS</button>
        </div>
        <div class="filter-area">
            <select id="prefFilter" onchange="resetAndRender()"><option value="ALL">PREFECTURE: ALL</option></select>
            <select id="stationFilter" onchange="resetAndRender()"><option value="ALL">STATION: ALL</option></select>
        </div>
        <div class="list-search-box">
            <span class="list-search-icon">üîç</span>
            <input type="text" id="searchInput" placeholder="Search by Name, ID..." oninput="resetAndRender()">
        </div>
        <div id="stats-area">
            <div class="stats-header">
                <div class="stats-total" id="stats-total-text">-- Results</div>
                <select id="limitSelect" class="limit-select" onchange="changeLimit()"><option value="100">Show: 100</option><option value="ALL">Show: ALL</option></select>
            </div>
            <div id="stats-detail" class="stats-grid"></div>
        </div>
        <div id="result-area"></div>
        <button id="load-more-btn" style="width:100%; padding:15px; background:transparent; border:1px solid var(--gold); color:var(--gold); border-radius:30px; margin-top:20px; display:none;" onclick="loadMore()">VIEW MORE</button>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
        <h3>SETTINGS</h3>
        <div class="settings-section">
            <label>API KEY</label>
            <div style="display:flex; gap:10px;"><input type="password" id="apiKey" style="flex:1;"><button onclick="saveKeyAndInit()" class="btn-sub">SAVE</button></div>
        </div>
        <div class="settings-section">
            <label>üì• DATA IMPORT</label>
            <div style="display:flex; gap:15px; margin-bottom:15px; background:#fcfcfc; padding:10px; border-radius:var(--radius);"><label><input type="radio" name="regMode" value="new" checked onchange="changeRegMode()"> NEW REG (6 Cols)</label><label><input type="radio" name="regMode" value="update" onchange="changeRegMode()"> UPDATE BLD (2 Cols)</label></div>
            <div id="mode-new-area"><label>REP NAME</label><input type="text" id="repName"></div>
            <label id="csv-label">DATA PASTE (6 Cols: ID|Corp|Shop|Building|Addr|Tel)</label>
            <textarea id="csvInput" style="height:120px;"></textarea>
            <button class="btn-main" id="runBtn" onclick="processData()">EXECUTE</button>
        </div>
        <div class="settings-section">
            <label>MY PINS (BLUE)</label><div id="rep-checklist" style="max-height:100px; overflow-y:auto;"></div>
        </div>
        <button class="btn-sub" style="width:100%; background:#f5f5f5;" onclick="document.getElementById('settingsModal').style.display='none'">CLOSE</button>
        <button class="btn-del" onclick="clearAll()">DELETE ALL DATA</button>
    </div>
</div>

<div id="editModal" class="modal-overlay">
    <div class="modal-content">
        <h3>EDIT INFO</h3>
        <input type="hidden" id="edit-id">
        <label>NOTE</label><textarea id="edit-note"></textarea>
        <label>REP</label><input type="text" id="edit-rep">
        <label>ID</label><input type="text" id="edit-r">
        <label>NAME</label><input type="text" id="edit-name">
        <label>BUILDING</label><input type="text" id="edit-building">
        <label>TEL</label><input type="text" id="edit-tel">
        <label>ADDRESS</label><input type="text" id="edit-addr">
        <div style="display:flex; gap:15px; margin-top:30px;"><button class="btn-sub" style="flex:1;" onclick="closeModal()">CANCEL</button><button class="btn-main" style="flex:1; margin-top:0;" onclick="saveEdit()">SAVE</button></div>
    </div>
</div>

<script>
    const DB_NAME = "map_db"; 
    let db = [], markers = [], targetReps = [], mapSyncMode = false, currentLimit = 100;
    let map, geocoder, AdvancedMarkerElement, myLocationMarker = null, watchId = null, isPinClick = false;

    window.onload = () => {
        const k = localStorage.getItem('map_apiKey'), d = localStorage.getItem(DB_NAME);
        if(d) db = JSON.parse(d);
        if(k) { document.getElementById('apiKey').value = k; initSystem(k); }
        populateFilters(); resetAndRender();
    };

    async function initSystem(key) {
        if(!document.querySelector('script[src*="maps.googleapis.com"]')) {
            const s = document.createElement('script');
            s.src = `https://maps.googleapis.com/maps/api/js?key=${key}&loading=async&libraries=places,geocoding,geometry,marker`;
            s.async = true; s.onload = async () => {
                const { Map } = await google.maps.importLibrary("maps");
                const { Geocoder } = await google.maps.importLibrary("geocoding");
                const { AdvancedMarkerElement: AM } = await google.maps.importLibrary("marker");
                AdvancedMarkerElement = AM; geocoder = new Geocoder();
                map = new Map(document.getElementById('google-map-view'), { center:{lat:35.68, lng:139.76}, zoom:13, mapId: "DEMO_MAP_ID", mapTypeControl: false, streetViewControl: false });
                map.addListener('idle', () => { if(!isPinClick && mapSyncMode) render(); isPinClick=false; });
                document.getElementById('map-placeholder-msg').style.display='none';
                render();
            };
            document.head.appendChild(s);
        }
    }

    function render() {
        const area = document.getElementById('result-area'); area.innerHTML = "";
        const fPref = document.getElementById('prefFilter').value;
        const q = normalize(document.getElementById('searchInput').value);
        let filtered = db.filter(d => {
            if(fPref !== "ALL" && !d.address.includes(fPref)) return false;
            if(!q) return true;
            return normalize(d.name + d.r_code + d.address + (d.building||"")).includes(q);
        });
        if(mapSyncMode && map) {
            const center = map.getCenter();
            filtered.forEach(d => d._dist = google.maps.geometry.spherical.computeDistanceBetween(center, new google.maps.LatLng(d.lat, d.lng)));
            filtered.sort((a, b) => a._dist - b._dist);
        }
        updateMapPins(filtered.slice(0, currentLimit));
        filtered.slice(0, currentLimit).forEach(c => {
            const div = document.createElement('div'); div.className = 'customer-item';
            div.innerHTML = `
                <div style="flex:1;"><div class="info-main">${c.name}</div><div class="info-sub"><span class="tag">${c.r_code||""}</span>${c.rep_name||""}</div><div class="info-sub">${c.address}</div><div class="info-sub" style="font-weight:600;">${c.building||""}</div><div class="info-sub">${c.tel||""}</div></div>
                <div class="action-area"><a href="tel:${c.tel}" class="icon-btn">üìû</a><button onclick="panToMap(${c.lat},${c.lng})" class="icon-btn">üìç</button><button onclick="openEdit('${c.id}')" class="icon-btn">‚úèÔ∏è</button></div>`;
            area.appendChild(div);
        });
        document.getElementById('stats-total-text').innerText = `${filtered.length} Results`;
        document.getElementById('load-more-btn').style.display = (filtered.length > currentLimit) ? 'block' : 'none';
        updateStatsUI(filtered);
    }

    function updateMapPins(targets) {
        if(!map || !AdvancedMarkerElement) return;
        markers.forEach(m => m.setMap(null)); markers = [];
        targets.forEach(c => {
            if(!c.lat) return;
            const pin = document.createElement("div"); pin.style.width="14px"; pin.style.height="14px"; pin.style.borderRadius="50%"; pin.style.border="2px solid white";
            pin.style.backgroundColor = targetReps.includes(c.rep_name) ? "#2196F3" : "#cc3300";
            const m = new AdvancedMarkerElement({ position:{lat:c.lat, lng:c.lng}, map:map, content:pin });
            m.addListener('click', () => { isPinClick=true; new google.maps.InfoWindow({ content: `<b>${c.name}</b><br>${c.building||''}` }).open(map, m); });
            markers.push(m);
        });
    }

    async function processData() {
        const mode = document.querySelector('input[name="regMode"]:checked').value;
        const csv = document.getElementById('csvInput').value.trim();
        if(!csv) return alert("Paste data first");
        if (mode === 'update') {
            csv.split('\n').forEach(l => { const c = l.split('\t'); const t = db.find(x => x.r_code === c[0]); if(t) t.building = c[1]; });
        } else {
            const rep = document.getElementById('repName').value;
            for(let l of csv.split('\n')) {
                const c = l.split('\t'); if(c.length < 5) continue;
                let r=c[0], n=(c[1]+" "+c[2]).trim(), b=c[3], a=c[4], t=c[5]||"";
                if(c.length === 5){ b=""; a=c[3]; t=c[4]; }
                try {
                    const res = await new Promise((res, rej) => geocoder.geocode({address: a}, (r, s) => s==='OK'?res(r[0].geometry.location):rej()));
                    db.push({ id: Math.random().toString(36).substr(2, 9), r_code: r, name: n, building: b, address: a, tel: t, lat: res.lat(), lng: res.lng(), rep_name: rep, note: "" });
                } catch(e){}
                await new Promise(r => setTimeout(r, 400));
            }
        }
        saveDB(); populateFilters(); render(); alert("Done");
    }

    function panToMap(lat, lng) { map.setZoom(17); map.panTo({lat, lng}); if(!document.getElementById('mapSyncToggle').checked){ document.getElementById('mapSyncToggle').checked=true; toggleMapSync(); } }
    function normalize(s) { return (s||"").replace(/[Ôº°-Ôº∫ÔΩÅ-ÔΩöÔºê-Ôºô]/g, c=>String.fromCharCode(c.charCodeAt(0)-0xFEE0)).toLowerCase().replace(/\s+/g,""); }
    function saveKeyAndInit() { localStorage.setItem('map_apiKey', document.getElementById('apiKey').value); location.reload(); }
    function saveDB() { localStorage.setItem(DB_NAME, JSON.stringify(db)); }
    function closeModal() { document.getElementById('editModal').style.display='none'; }
    function changeLimit() { currentLimit = document.getElementById('limitSelect').value === 'ALL' ? db.length : 100; render(); }
    function toggleMapSync() { mapSyncMode = document.getElementById('mapSyncToggle').checked; render(); }
    function openSettings() { document.getElementById('settingsModal').style.display='flex'; }
    function openEdit(id) { const d = db.find(x => x.id === id); if(d) { document.getElementById('edit-id').value=d.id; document.getElementById('edit-note').value=d.note; document.getElementById('edit-r').value=d.r_code; document.getElementById('edit-rep').value=d.rep_name; document.getElementById('edit-name').value=d.name; document.getElementById('edit-building').value=d.building; document.getElementById('edit-tel').value=d.tel; document.getElementById('edit-addr').value=d.address; document.getElementById('editModal').style.display='flex'; } }
    function saveEdit() { const id = document.getElementById('edit-id').value; const t = db.find(x => x.id === id); if(t){ t.note = document.getElementById('edit-note').value; t.r_code = document.getElementById('edit-r').value; t.rep_name = document.getElementById('edit-rep').value; t.name = document.getElementById('edit-name').value; t.address = document.getElementById('edit-addr').value; t.building = document.getElementById('edit-building').value; t.tel = document.getElementById('edit-tel').value; } saveDB(); render(); closeModal(); }
    function populateFilters() { const p = document.getElementById('prefFilter'); p.innerHTML = '<option value="ALL">PREFECTURE: ALL</option>'; [...new Set(db.map(x => x.address.match(/(...??[ÈÉΩÈÅìÂ∫úÁúå])/)?.[1] || "Other"))].sort().forEach(x => { const o = document.createElement('option'); o.value=x; o.innerText=x; p.appendChild(o); }); }
    function updateStatsUI(filtered) { const counts = {}; filtered.forEach(d => counts[d.rep_name||"Unknown"] = (counts[d.rep_name||"Unknown"]||0)+1); const area = document.getElementById('stats-detail'); area.innerHTML = ""; Object.keys(counts).forEach(k => { const s = document.createElement('span'); s.className = 'stats-item'; s.innerText = `${k}: ${counts[k]}`; area.appendChild(s); }); }
</script>
</body>
</html>
